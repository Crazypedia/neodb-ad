# Generated by Django 4.2.18 on 2025-01-27 05:56

from django.conf import settings
from django.db import migrations

from catalog.common.migrations import merge_works_20250301


def process_pending_trigger_events(apps, schema_editor):
    # Ensure all pending trigger events are processed
    schema_editor.connection.cursor().execute("SET CONSTRAINTS ALL IMMEDIATE")


def merge_works(apps, schema_editor):
    skips = getattr(settings, "SKIP_MIGRATIONS", [])
    if "merge_works" in skips:
        print("(Skipped)", end="")
        return
    Edition = apps.get_model("catalog", "Edition")
    Work = apps.get_model("catalog", "Work")
    merge_works_20250301(Edition, Work)


class Migration(migrations.Migration):
    dependencies = [
        ("catalog", "0002_fix_soft_deleted_edition"),
    ]

    operations = [
        # migrations.AlterField(
        #     model_name="work",
        #     name="editions",
        #     field=models.ManyToManyField(related_name="+", to="catalog.edition"),
        # ),
        migrations.RunPython(process_pending_trigger_events),
        migrations.RunPython(merge_works),
    ]
