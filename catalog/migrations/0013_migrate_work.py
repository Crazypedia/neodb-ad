# Generated by Django 4.2.18 on 2025-01-27 05:56

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models

from catalog.common.migrations import merge_works_20250301


def process_pending_trigger_events(apps, schema_editor):
    # Ensure all pending trigger events are processed
    schema_editor.connection.cursor().execute("SET CONSTRAINTS ALL IMMEDIATE")


def merge_works(apps, schema_editor):
    skips = getattr(settings, "SKIP_MIGRATIONS", [])
    if "merge_works" in skips:
        print("(Skipped)", end="")
        return
    Edition = apps.get_model("catalog", "Edition")
    merge_works_20250301(Edition)


class Migration(migrations.Migration):
    dependencies = [
        ("catalog", "0002_fix_soft_deleted_edition"),
    ]

    operations = [
        migrations.AddField(
            model_name="edition",
            name="related_work",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="related_editions",
                to="catalog.work",
            ),
        ),
        migrations.RunPython(process_pending_trigger_events),
        migrations.RunPython(merge_works),
    ]
